# GitLab CI/CD Pipeline for Flow Master Company Website
# Domain: flow-master.ai | Server: 91.99.237.14

stages:
  - security
  - quality
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  DEPLOY_SERVER: "91.99.237.14"
  DEPLOY_USER: "deploy"
  DEPLOY_PATH: "/var/www/flow-master"
  PM2_APP_NAME: "flow-master-website"

# Cache node_modules between jobs
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/

# Base template for Node.js jobs
.node_base:
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline

# ==================== SECURITY STAGE ====================

# NPM Audit - Check for known vulnerabilities in dependencies
npm_audit:
  extends: .node_base
  stage: security
  script:
    - echo "Running npm audit for security vulnerabilities..."
    - npm audit --audit-level=moderate || true
    - npm audit --json > npm-audit-report.json || true
  artifacts:
    paths:
      - npm-audit-report.json
    expire_in: 1 week
    when: always
  allow_failure: true

# Dependency scanning using GitLab's built-in scanner
dependency_scanning:
  stage: security
  image: node:${NODE_VERSION}-alpine
  script:
    - npm ci --cache .npm --prefer-offline
    - echo "Checking for outdated dependencies..."
    - npm outdated || true
    - echo "Checking for duplicate dependencies..."
    - npm ls --all > dependency-tree.txt 2>&1 || true
  artifacts:
    paths:
      - dependency-tree.txt
    expire_in: 1 week
  allow_failure: true

# Secret detection - Check for hardcoded secrets
secret_detection:
  stage: security
  image: alpine:latest
  before_script:
    - apk add --no-cache grep
  script:
    - echo "Scanning for potential secrets and API keys..."
    - |
      # Check for common secret patterns (excluding node_modules and .git)
      PATTERNS="(api[_-]?key|apikey|secret[_-]?key|password|passwd|pwd|token|auth[_-]?token|access[_-]?token|private[_-]?key|client[_-]?secret)"
      if grep -riE "$PATTERNS" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" --exclude-dir=node_modules --exclude-dir=.git --exclude="package*.json" . 2>/dev/null; then
        echo "WARNING: Potential secrets detected. Please review the above matches."
      else
        echo "No obvious secrets detected."
      fi
  allow_failure: true

# ==================== QUALITY STAGE ====================

# ESLint - Code linting
eslint:
  extends: .node_base
  stage: quality
  script:
    - echo "Running ESLint..."
    - npm run lint
  allow_failure: false

# TypeScript - Type checking
typescript_check:
  extends: .node_base
  stage: quality
  script:
    - echo "Running TypeScript type check..."
    - npx tsc --noEmit
  allow_failure: false

# Prettier - Code formatting check (optional, add prettier to package.json if needed)
prettier_check:
  extends: .node_base
  stage: quality
  script:
    - echo "Checking code formatting with Prettier..."
    - npx prettier --check "**/*.{ts,tsx,js,jsx,json,css,md}" --ignore-path .gitignore || echo "Prettier check completed with warnings"
  allow_failure: true

# Bundle size analysis
bundle_analysis:
  extends: .node_base
  stage: quality
  script:
    - echo "Analyzing bundle size..."
    - npm run build
    - echo "Build completed. Analyzing output..."
    - du -sh .next/ || true
    - find .next -name "*.js" -type f -exec du -h {} \; | sort -rh | head -20 || true
  artifacts:
    paths:
      - .next/
    expire_in: 1 day
  allow_failure: true

# ==================== BUILD STAGE ====================

build:
  extends: .node_base
  stage: build
  script:
    - echo "Building Next.js application..."
    - npm run build
    - echo "Build completed successfully!"
  artifacts:
    paths:
      - .next/
      - public/
      - package.json
      - package-lock.json
      - next.config.ts
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests

# ==================== DEPLOY STAGE ====================

# Deploy to production server
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client rsync
    - eval $(ssh-agent -s)
    - chmod 400 "$SSH_PRIVATE_KEY"
    - ssh-add "$SSH_PRIVATE_KEY"
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to production server $DEPLOY_SERVER..."

    # Sync files to server
    - |
      rsync -avz --delete \
        --exclude '.git' \
        --exclude 'node_modules' \
        --exclude '.gitlab-ci.yml' \
        .next/ \
        public/ \
        package.json \
        package-lock.json \
        next.config.ts \
        $DEPLOY_USER@$DEPLOY_SERVER:$DEPLOY_PATH/

    # Install dependencies and restart application on server
    - |
      ssh $DEPLOY_USER@$DEPLOY_SERVER << 'EOF'
        cd /var/www/flow-master
        npm ci --production
        pm2 restart flow-master-website || pm2 start npm --name "flow-master-website" -- start
        pm2 save
        echo "Deployment completed!"
      EOF

  environment:
    name: production
    url: https://flow-master.ai
  only:
    - main
  dependencies:
    - build

# Deploy to staging (optional)
deploy_staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client rsync
    - eval $(ssh-agent -s)
    - chmod 400 "$SSH_PRIVATE_KEY"
    - ssh-add "$SSH_PRIVATE_KEY"
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to staging..."
    - |
      rsync -avz --delete \
        --exclude '.git' \
        --exclude 'node_modules' \
        --exclude '.gitlab-ci.yml' \
        .next/ \
        public/ \
        package.json \
        package-lock.json \
        next.config.ts \
        $DEPLOY_USER@$DEPLOY_SERVER:$DEPLOY_PATH-staging/
    - |
      ssh $DEPLOY_USER@$DEPLOY_SERVER << 'EOF'
        cd /var/www/flow-master-staging
        npm ci --production
        pm2 restart flow-master-staging || pm2 start npm --name "flow-master-staging" -- start -- -p 3001
        pm2 save
      EOF
  environment:
    name: staging
    url: https://staging.flow-master.ai
  only:
    - develop
  when: manual
  dependencies:
    - build
